name: NHL Daily Picks (Pages)

on:
  workflow_dispatch:
    inputs:
      games_date:
        description: "Slate date (YYYY-MM-DD). Leave blank for today (UTC)."
        required: false
        default: ""
  schedule:
    # 10:00 UTC daily (adjust if you want)
    - cron: "0 10 * * *"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      SITE_DIR: site
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      # ---------- Smoke test: prints teams/players/rates to the CI logs ----------
      - name: Smoke test live fetch
        env:
          GAMES_DATE: ${{ github.event.inputs.games_date }}
        run: |
          set -e
          if [ -z "$GAMES_DATE" ]; then
            GAMES_DATE=$(date -u +%F)
          fi
          echo "Using GAMES_DATE=$GAMES_DATE"
          python scripts/smoke_test.py || true  # don't fail the job on smoke test

      # ---------- Build site ----------
      - name: Build site
        env:
          GAMES_DATE: ${{ github.event.inputs.games_date }}
        run: |
          set -e
          if [ -z "$GAMES_DATE" ]; then
            GAMES_DATE=$(date -u +%F)
          fi
          rm -rf "$SITE_DIR"
          mkdir -p "$SITE_DIR"

          # Generate JSON + HTML into $SITE_DIR
          python -m nhl_picks.cli \
            --date "$GAMES_DATE" \
            --out "$SITE_DIR" \
            --last-n 5 \
            --w-recent 0.65

          # List outputs for debugging
          echo "---- built files ----"
          find "$SITE_DIR" -maxdepth 2 -type f -print

      # ---------- Upload + Deploy GitHub Pages ----------
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
